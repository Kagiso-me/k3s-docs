# ----------------------------------------
# K3s Backup Alerts
# Monitors manifests, node backups, and PV backups
# ----------------------------------------

groups:
  - name: k3s_backup_alerts
    rules:

      # ----------------------
      # Stale Backups (older than 24h)
      # ----------------------

      - alert: K3sBackupStale_Manifests
        expr: time() - k3s_backup_last_mtime{type="manifests"} > 86400
        for: 15m
        labels:
          severity: warning
        annotations:
          summary: "K3s Manifests Backup Stale"
          description: "The manifests backup has not been updated in the last 24 hours."

      - alert: K3sBackupStale_NodeJaime
        expr: time() - k3s_backup_last_mtime{type="node_jaime"} > 86400
        for: 15m
        labels:
          severity: warning
        annotations:
          summary: "K3s Node Jaime Backup Stale"
          description: "The backup for node Jaime has not updated in the last 24 hours."

      - alert: K3sBackupStale_NodeTyrion
        expr: time() - k3s_backup_last_mtime{type="node_tyrion"} > 86400
        for: 15m
        labels:
          severity: warning
        annotations:
          summary: "K3s Node Tyrion Backup Stale"
          description: "The backup for node Tyrion has not updated in the last 24 hours."

      - alert: K3sBackupStale_PV
        expr: time() - k3s_backup_last_mtime{type="pv_backup"} > 86400
        for: 15m
        labels:
          severity: warning
        annotations:
          summary: "K3s PV Backup Stale"
          description: "The persistent volume backup has not updated in the last 24 hours."

      # ----------------------
      # Empty Backups (0 bytes)
      # ----------------------

      - alert: K3sBackupEmpty_Manifests
        expr: k3s_backup_dir_size{type="manifests"} == 0
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "K3s Manifests Backup Empty"
          description: "The manifests backup directory is empty."

      - alert: K3sBackupEmpty_NodeJaime
        expr: k3s_backup_dir_size{type="node_jaime"} == 0
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "K3s Node Jaime Backup Empty"
          description: "The backup directory for node Jaime is empty."

      - alert: K3sBackupEmpty_NodeTyrion
        expr: k3s_backup_dir_size{type="node_tyrion"} == 0
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "K3s Node Tyrion Backup Empty"
          description: "The backup directory for node Tyrion is empty."

      - alert: K3sBackupEmpty_PV
        expr: k3s_backup_dir_size{type="pv_backup"} == 0
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "K3s PV Backup Empty"
          description: "The persistent volume backup directory is empty."
